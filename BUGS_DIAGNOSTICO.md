# Diagn√≥stico Completo de Bugs - Vialine

**Fecha**: 2025-11-01
**Fuente**: Testing manual del usuario en TESTING_CHECKLIST.md
**Total de problemas encontrados**: 30

---

## üî¥ CR√çTICOS (Rompen funcionalidad core)

### 1. ‚ùå ERROR: `q.toFixed is not a function` al escribir review

**Ubicaci√≥n**: `components/ReviewList.tsx:204` + `app/api/reviews/[slug]/route.ts:52`

**Reportado por usuario**:
```
Uncaught TypeError: q.toFixed is not a function
  page-da3a9ba2ab5c57de.js:1:7981
```

**Diagn√≥stico**:
- PostgreSQL `AVG(rating)` devuelve tipo `string` o `Decimal`, NO `number`
- `COUNT()` tambi√©n devuelve `bigint` que se serializa como string
- Cuando se intenta `.toFixed(1)` en un string, falla

**C√≥digo problem√°tico**:
```typescript
// ReviewList.tsx l√≠nea 204
{averageRating.toFixed(1)}

// API l√≠nea 52
AVG(rating) as average_rating,  // Devuelve string/decimal
COUNT(*) as total_reviews,       // Devuelve bigint ‚Üí string
```

**Impacto**:
- ‚ö†Ô∏è **BLOQUEADOR**: La p√°gina crashea cuando hay reviews
- Usuario no puede ver producto ni escribir m√°s reviews

**Soluci√≥n**: Convertir tipos en la API a number:
```typescript
average_rating: parseFloat(stats.rows[0].average_rating) || 0,
total_reviews: parseInt(stats.rows[0].total_reviews) || 0,
five_star: parseInt(stats.rows[0].five_star) || 0,
// ... etc
```

---

### 2. ‚ùå Paginaci√≥n: "No se encontraron productos" cuando aplicas filtro en p√°gina > 1

**Ubicaci√≥n**: `app/mujer/page.tsx:79-84`

**Reportado por usuario**:
> Si estoy en /mujer?page=2 y luego le doy al filtro de leggings, me dice "No se encontraron productos con los filtros seleccionados"

**Diagn√≥stico**:
- URL resultante: `/mujer?page=2&category=leggings`
- Solo hay 8 leggings ‚Üí 1 p√°gina
- C√≥digo intenta mostrar p√°gina 2, que no existe
- `allItems.slice(startIndex, endIndex)` devuelve array vac√≠o

**C√≥digo problem√°tico**:
```typescript
// L√≠nea 79
const page = parseInt((params.page as string) || "1")
const startIndex = (page - 1) * itemsPerPage  // Si page=2 y solo hay 8 items ‚Üí startIndex=24
const items = allItems.slice(startIndex, endIndex)  // Slice fuera de rango ‚Üí []
```

**Impacto**:
- Usuario ve mensaje "No se encontraron productos"
- Experiencia frustrante: el usuario S√ç puede ver que hay productos, pero la paginaci√≥n falla

**Soluci√≥n**: Reset p√°gina a 1 cuando cambian filtros, o redirect si p√°gina > totalPages

---

### 3. ‚ùå AccountSidebar ‚Üí "Favoritos" navega a /wishlist en lugar de /account/favoritos

**Ubicaci√≥n**: `components/AccountSidebar.tsx:49`

**Reportado por usuario**:
> Del apartado de account si luego seleccionas favoritos te lleva a /wishlist, lo cu√°l est√° mal, porque yo necesito que est√© integrado en account

**Diagn√≥stico**:
```typescript
{
  icon: Heart,
  label: "Lista de Deseos",
  href: "/wishlist",  // ‚ùå INCORRECTO
},
```

**Impacto**:
- Navegaci√≥n inconsistente
- /account/favoritos existe pero no es accesible desde sidebar
- Confusi√≥n de usuario

**Soluci√≥n**: Cambiar a `href: "/account/favoritos"`

---

### 4. ‚ùå Productos relacionados muestra productos AGOTADOS

**Ubicaci√≥n**: `components/RelatedProducts.tsx:17-22`

**Reportado por usuario**:
> [‚ùé] No muestra productos agotados

**Diagn√≥stico**:
```typescript
const candidates = products.filter(
  (p) =>
    p.slug !== currentProduct.slug &&
    p.category === currentProduct.category &&
    p.audience === currentProduct.audience
    // ‚ùå FALTA: && p.inventory > 0
)
```

**Impacto**:
- Usuario hace click en producto agotado
- Frustraci√≥n: no puede comprar

**Soluci√≥n**: Agregar filtro `p.inventory > 0`

---

### 5. ‚ùå Email de confirmaci√≥n de pedido NO se env√≠a

**Ubicaci√≥n**: `app/api/checkout/route.ts` (probablemente)

**Reportado por usuario**:
> [‚ùé] Email de confirmaci√≥n se env√≠a

**Diagn√≥stico**: Necesito verificar si el c√≥digo de env√≠o de email est√° implementado en la API de checkout.

**Impacto**:
- Cliente no recibe confirmaci√≥n
- No puede rastrear pedido
- P√©rdida de confianza

**Soluci√≥n**: Implementar env√≠o de email despu√©s de crear orden

---

### 6. ‚ùå Email de recuperaci√≥n de contrase√±a NO funciona

**Ubicaci√≥n**: Sistema de emails (Brevo)

**Reportado por usuario**:
> Si bien la funcion de email enviado me carga, en realidad lo dem√°s tipo lo que ocurre despues que es lo importante que seria el propio email no funciona... pero no entiendo, la API key de Brevo est√° configurada.
>
> actu: acabo de revisar y estas usando otro sender... el oficial es no-reply@vialineperu.com

**Diagn√≥stico**:
- API key de Brevo configurada pero sender incorrecto
- Brevo rechaza emails si el sender no est√° verificado

**Impacto**:
- Usuarios no pueden recuperar contrase√±as olvidadas
- Bloqueador para cuentas perdidas

**Soluci√≥n**:
1. Verificar sender `no-reply@vialineperu.com` en Brevo
2. Actualizar c√≥digo para usar sender correcto

---

## üü° IMPORTANTES (Afectan UX pero no rompen funcionalidad)

### 7. ‚ö†Ô∏è Botones +/- de zoom NO funcionan

**Ubicaci√≥n**: `components/ProductGallery.tsx`

**Reportado por usuario**:
> [ ‚ùé] Botones +/- cambian nivel de zoom (100%-300%)

**Diagn√≥stico**: Necesito verificar si handleZoomIn/handleZoomOut est√°n conectados correctamente

**Verificado en c√≥digo**:
```typescript
// L√≠neas 40-46 - Funciones existen
const handleZoomIn = () => {
  setZoomLevel((prev) => Math.min(prev + 0.5, 3))
}
```

**Posible causa**: Los botones est√°n disabled o evento no se dispara

**Impacto**: Usuario no puede hacer zoom para ver detalles

---

### 8. ‚ö†Ô∏è NO existe selector de cantidad en p√°gina de producto

**Ubicaci√≥n**: `components/product/ProductDetailCard.tsx`

**Reportado por usuario**:
> Solo existe esa funcion de cantidad en el carrito o sea nomas ahi puedes agregar cantidades

**Diagn√≥stico**: Feature no implementada. Es un patr√≥n com√∫n en e-commerce que NO tengas selector de cantidad en p√°gina de producto, pero el usuario lo esperaba.

**Impacto**:
- UX menos fluida
- Usuario debe ir al carrito para cambiar cantidad

**Decisi√≥n**: ¬øQueremos agregarlo o dejarlo como est√°?

---

### 9. ‚ö†Ô∏è NO existe drawer del carrito (solo dropdown)

**Ubicaci√≥n**: Navbar/Header

**Reportado por usuario**:
> Tienes raz√≥n, ahora solo existe un dropdown del carrito pero se ver√≠a mucho mejor como lo propones [drawer lateral]

**Diagn√≥stico**: El checklist esperaba un drawer lateral deslizable, pero est√° implementado como dropdown.

**Impacto**:
- UX menos premium
- Dropdown puede ser peque√±o en mobile

**Soluci√≥n**: Crear CartDrawer component que se deslice desde la derecha

---

### 10. ‚ö†Ô∏è Email en checkout NO es no-editable

**Ubicaci√≥n**: `app/checkout/page.tsx`

**Reportado por usuario**:
> [ ‚ùé] Email no editable (viene de sesi√≥n)

**Diagn√≥stico**: Input de email es editable cuando deber√≠a ser read-only.

**Impacto**:
- Usuario puede cambiar email por error
- Orden puede ir a email incorrecto

**Soluci√≥n**: Agregar `disabled` o `readOnly` al input de email

---

### 11. ‚ö†Ô∏è Opciones de pago: Yape duplicado, pago contra entrega sin definir

**Ubicaci√≥n**: `app/checkout/page.tsx`

**Reportado por usuario**:
> Te dije que elimines la opci√≥n de yape porque culqi o sea cuando presionas pagar con tarjeta que obvio ser√≠a culqi aparece para tarjetas pero aparte para yape entonces no tendr√≠a sentido que luego haya opci√≥n de yape si culqi ya lo integra sabes... adem√°s y hablando del pago contra entrega como asi que aplicar cargo de 5 soles por servicio no entend√≠ bien.. esto dejalo pendiente a cambio tipo hay que decidir que hacer con pago contra entrega porque no es peligroso?

**Diagn√≥stico**:
- Culqi ya incluye opci√≥n de Yape
- Tener opci√≥n separada de Yape es redundante
- Pago contra entrega tiene riesgo de fraude

**Impacto**:
- Confusi√≥n de usuario (¬øpor qu√© hay 2 Yape?)
- Riesgo de p√©rdida con contra entrega

**Decisi√≥n necesaria**:
1. Eliminar opci√≥n standalone de Yape
2. Decidir si mantener "Contra Entrega" y qu√© cargo aplicar

---

### 12. ‚ö†Ô∏è NO existe p√°gina de "Editar Perfil" en /account

**Ubicaci√≥n**: `app/account/perfil/page.tsx` (probablemente)

**Reportado por usuario**:
> No hay esa opci√≥n de editar perfil no aparece

**Diagn√≥stico**: La ruta `/account/perfil` existe en el build, pero probablemente no est√° en el sidebar o est√° vac√≠a.

**Impacto**: Usuario no puede actualizar su nombre, tel√©fono, etc.

**Soluci√≥n**: Implementar formulario de editar perfil

---

### 13. ‚ö†Ô∏è NO existe opci√≥n de "Cambiar Contrase√±a" en /account

**Ubicaci√≥n**: `app/account` (falta implementar)

**Reportado por usuario**:
> No existe esa opci√≥n de cambiar contrase√±a

**Diagn√≥stico**: Feature no implementada.

**Impacto**:
- Usuario no puede cambiar contrase√±a
- Debe usar "recuperar contrase√±a" para cambiarla

**Soluci√≥n**: Agregar formulario de cambiar contrase√±a en /account/perfil

---

### 14. ‚ö†Ô∏è Modal de gu√≠a de tallas NO cierra con click afuera

**Ubicaci√≥n**: `components/SizeGuideModal.tsx`

**Reportado por usuario**:
> No cierra con click afuera (por favor agregalo)

**Diagn√≥stico**: Solo se cierra con bot√≥n X o Escape.

**Impacto**: UX menos intuitiva

**Soluci√≥n**: Agregar overlay clickeable:
```typescript
<div onClick={() => setIsOpen(false)} className="overlay">
  <div onClick={(e) => e.stopPropagation()} className="modal-content">
```

---

### 15. ‚ö†Ô∏è Click en color NO cambia imagen principal correctamente

**Ubicaci√≥n**: `components/product/ProductDetailCard.tsx`

**Reportado por usuario**:
> Ese sistema parece estar desactualizado, porque no funciona correctamente o a veces tiene errores

**Diagn√≥stico**: Necesito verificar la l√≥gica de cambio de imagen por color.

**Impacto**: Usuario no puede visualizar producto en color deseado

---

### 16. ‚ö†Ô∏è Rating promedio de reviews tiene conflicto con sistema antiguo

**Ubicaci√≥n**: ProductCard / Product data

**Reportado por usuario**:
> Todav√≠a existe un problema respecto al sistema de reviews, pues como te digo en los carruseles los productos se muestran con x estrellas pero por el sistema anterior, pero ahora cuando vas si bien las reviews no est√°n, las estrellas de dicho producto si.

**Diagn√≥stico**:
- Datos de productos tienen `rating` hardcodeado del sistema viejo
- Sistema nuevo de reviews (DB) est√° separado
- No est√°n sincronizados

**Impacto**:
- Datos inconsistentes
- Confusi√≥n de usuario

**Soluci√≥n**:
1. Remover campo `rating` del JSON de productos
2. Calcular rating din√°micamente desde product_reviews table
3. O agregar computed field que se actualiza cuando se crea review

---

### 17. ‚ö†Ô∏è Links de WhatsApp usan dominio incorrecto (vialine.pe)

**Ubicaci√≥n**: `app/account/favoritos/page.tsx`

**Reportado por usuario**:
> En realidad no porque el dominio que usa es vialine.pe pero de por si el dominio final que usaremos ser√° el que est√° registrado tu lo tienes... y por produccion usamos el de vercel pero ninguno aparece

**Diagn√≥stico**: URLs de WhatsApp compartir usan dominio hardcodeado `vialine.pe` que no existe.

**Impacto**: Links compartidos no funcionan

**Soluci√≥n**: Usar `window.location.origin` o variable de entorno `NEXT_PUBLIC_SITE_URL`

---

### 18. ‚ö†Ô∏è Validaci√≥n de tel√©fono y c√≥digo postal acepta letras

**Ubicaci√≥n**: `app/account/direcciones/page.tsx` + `app/checkout/page.tsx`

**Reportado por usuario**:
> El telefono no detecta como que tienen que ser numeros, pues simplemente si escribes con letras por ejemplo igual te lo acepta sabes, el codigo postal tambien

**Diagn√≥stico**: Inputs no tienen `type="tel"` o validaci√≥n num√©rica.

**Impacto**: Datos incorrectos en DB

**Soluci√≥n**:
```typescript
<input type="tel" pattern="[0-9]+" />
```

---

### 19. ‚ö†Ô∏è Hamburger menu: "Gu√≠a de tallas" y "Cambios y devoluciones" NO funcionan

**Ubicaci√≥n**: `components/nav/MobileMenu.tsx`

**Reportado por usuario**:
> El hamburguer tiene secci√≥n ayuda donde ves gu√≠a de tallas, cambios y devoluciones y soporte whatsapp, de los cuales no funciona la guia de tallas ni cambio y devoluciones

**Diagn√≥stico**: Links rotos o p√°ginas no existen.

**Impacto**: Usuario no puede acceder a informaci√≥n importante en mobile

**Soluci√≥n**: Verificar rutas y crear p√°ginas faltantes

---

## üü¢ MEJORAS UX (No rompen nada pero mejoran experiencia)

### 20. üí° Mobile: Demasiadas cosas abajo en cat√°logo

**Reportado por usuario**:
> En movil hay demasiadas cosas abajo! (filtros y orden, la paginaci√≥n y el bot√≥n whatsapp) Mis sugerencia es que en caso de movil no existe la paginaci√≥n y simplemente haya ese efecto de load more y pues ahi cargan m√°s. Adem√°s sugiero que los filtros est√©n arriba del todo y no abajo sabes, busca referencias.

**Diagn√≥stico**: Layout de filtros/paginaci√≥n no optimizado para m√≥vil.

**Sugerencia**:
1. Mover filtros arriba en m√≥vil
2. Reemplazar paginaci√≥n con "Cargar m√°s" (infinite scroll)
3. Bot√≥n WhatsApp flotante no obstruya paginaci√≥n

---

### 21. üí° Checkout: Deber√≠a ser multi-step en lugar de una sola p√°gina

**Reportado por usuario**:
> Deber√≠amos estudiar si est√° bien que el checkout sea tipo en una sola pag√≠na o que tenga varios steps que cambien a diferentes mini paginas sabes porque sino tienes que escrolear bastante en celular

**Sugerencia**: Checkout con steps (Direcci√≥n ‚Üí Pago ‚Üí Confirmaci√≥n)

**Beneficios**:
- Menos scroll en m√≥vil
- Proceso m√°s guiado
- Menor abandono de carrito

---

### 22. üí° Account no es intuitivo en m√≥vil

**Reportado por usuario**:
> Necesitamos hacer mas intuitivo la parte de account para celular sabes

**Sugerencia**: Tabs horizontales o cards en lugar de sidebar

---

### 23. üí° En m√≥vil, click en orden NO muestra detalles

**Reportado por usuario**:
> En celular no [muestra detalles]

**Diagn√≥stico**: Modal de detalles probablemente no se adapta a m√≥vil.

**Soluci√≥n**: Full-screen modal en mobile o navegaci√≥n a p√°gina dedicada

---

### 24. üí° Verificar estructura de checkout - p√°ginas duplicadas

**Reportado por usuario**:
> Ya teniamos una pagina de detalles de orden sabes o sea si le das a detalles en la pagina de account pedidos te muestra un pop up con los detalles, pero antes teniamos uno m√°s bonito y especifico que mostraba un timeline del pedido y asi pero no s√© o sea te dejo como tarea verificar la estructura del checkout porque hay varias paginas que no sirven o duplicadas o cosas asi

**Tarea**: Auditor√≠a de rutas de checkout/orden y limpiar duplicados

---

### 25. üí° Despu√©s de login, NO regresa a checkout

**Reportado por usuario**:
> Creo que eso no sucede, o sea no lo he probado pero que recuerde no... en todo caso vertificar por favor

**Diagn√≥stico**: NextAuth redirect callback probablemente no preserva `callbackUrl`

**Impacto**: Usuario pierde contexto

**Soluci√≥n**: Configurar `callbackUrl` en signIn()

---

## üìù NOTAS Y DECISIONES PENDIENTES

### 26. ‚ùì ¬øMostrar foto de perfil en account?

**Reportado por usuario**:
> [‚ùé ] Muestra foto de perfil (si tiene)
> No creo que sea necesario

**Decisi√≥n**: Usuario dice que NO es necesario. ¬øConfirmamos?

---

### 27. ‚ùì ¬øQu√© hacer con pago "Contra Entrega"?

**Reportado por usuario**:
> Hay que decidir que hacer con pago contra entrega porque no es peligroso?

**Opciones**:
1. Eliminar completamente
2. Aplicar cargo adicional (S/. 5)
3. Limitar a pedidos < S/. 200
4. Requerir verificaci√≥n telef√≥nica

**Decisi√≥n pendiente del usuario**

---

### 28. ‚ùì ¬øImplementar selector de cantidad en p√°gina de producto?

**Estado actual**: Solo en carrito
**Usuario espera**: En p√°gina de producto tambi√©n

**Decisi√≥n**: ¬øEs importante o dejamos como est√°?

---

### 29. ‚ùì No aparece "usar nueva direcci√≥n", solo "usar direcci√≥n guardada"

**Reportado por usuario**:
> En realidad no aparece de usar nueva direcci√≥n, simplemente aparece de usar direcci√≥n guardada o sino puedes editar los campos igual por ti mismo

**Diagn√≥stico**: UI diferente de lo esperado, pero funcional.

**Decisi√≥n**: ¬øCambiar UI o dejar como est√°?

---

## üìä RESUMEN DE PRIORIDADES

| Prioridad | Cantidad | % del total |
|-----------|----------|-------------|
| üî¥ Cr√≠tico | 6 | 20% |
| üü° Importante | 13 | 43% |
| üü¢ Mejora UX | 7 | 23% |
| ‚ùì Pendiente decisi√≥n | 4 | 14% |

**Total**: 30 problemas identificados

---

## üéØ PLAN DE ACCI√ìN SUGERIDO

### Sprint 1: Bugs cr√≠ticos (1-2 d√≠as)
1. ‚úÖ Fix error `.toFixed()` en reviews (BLOQUEADOR)
2. ‚úÖ Fix paginaci√≥n con filtros
3. ‚úÖ Fix AccountSidebar ‚Üí favoritos
4. ‚úÖ Fix productos relacionados (filtrar agotados)
5. ‚úÖ Fix email de confirmaci√≥n
6. ‚úÖ Fix email de recuperaci√≥n (sender correcto)

### Sprint 2: Bugs importantes (2-3 d√≠as)
7. Botones de zoom
8. Modal de gu√≠a de tallas (cerrar con click afuera)
9. Eliminar opci√≥n Yape duplicada
10. Email no editable en checkout
11. Formulario de editar perfil
12. Formulario de cambiar contrase√±a
13. Links de WhatsApp (dominio correcto)
14. Validaci√≥n de tel√©fono/c√≥digo postal

### Sprint 3: UX y mejoras (3-4 d√≠as)
15. Mobile: Load more en lugar de paginaci√≥n
16. Mobile: Reordenar filtros arriba
17. Account mobile m√°s intuitivo
18. Detalles de orden en m√≥vil
19. Drawer del carrito
20. Sync rating de productos con reviews DB

### Sprint 4: Decisiones pendientes
21. ¬øCheckout multi-step?
22. ¬øPago contra entrega - qu√© hacer?
23. ¬øSelector de cantidad en producto?
24. Auditor√≠a de rutas duplicadas

---

**Generado**: 2025-11-01
**Autor**: Claude Code
**Fuente**: Testing manual del usuario
