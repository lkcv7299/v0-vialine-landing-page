#!/usr/bin/env node

/**
 * PROCESADOR BATCH DIRECTO
 * Procesa el CSV generado sin interacci√≥n
 */

const fs = require('fs')
const path = require('path')

const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  cyan: '\x1b[36m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  magenta: '\x1b[35m'
}

const log = {
  info: (msg) => console.log(`${colors.cyan}‚Ñπ${colors.reset} ${msg}`),
  success: (msg) => console.log(`${colors.green}‚úì${colors.reset} ${msg}`),
  warning: (msg) => console.log(`${colors.yellow}‚ö†${colors.reset} ${msg}`),
  error: (msg) => console.log(`${colors.red}‚úó${colors.reset} ${msg}`),
  title: (msg) => console.log(`\n${colors.bright}${colors.magenta}${msg}${colors.reset}\n`)
}

log.title('üé® PROCESADOR BATCH DE IM√ÅGENES')

const csvPath = path.join(__dirname, 'products-mapped.csv')

if (!fs.existsSync(csvPath)) {
  log.error('No se encontr√≥ products-mapped.csv')
  process.exit(1)
}

log.info('Leyendo CSV...')
const csvContent = fs.readFileSync(csvPath, 'utf-8')
const lines = csvContent.split('\n').slice(1) // Skip header

log.info(`Total de im√°genes a procesar: ${lines.length}`)
log.warning('NOTA: Este proceso puede tardar 10-15 minutos')
log.info('Procesando...\n')

let processed = 0
let errors = 0

// Agrupar por producto base
const productsMap = new Map()

for (const line of lines) {
  if (!line.trim()) continue

  try {
    // Parse CSV line
    const regex = /"([^"]*)"(?:,|$)|([^,]+)(?:,|$)/g
    const values = []
    let match

    while ((match = regex.exec(line)) !== null) {
      values.push(match[1] !== undefined ? match[1] : match[2])
    }

    if (values.length < 7) continue

    const [imagePath, productName, color, category, audience, fabric, price, stock] = values

    if (!fs.existsSync(imagePath)) {
      log.warning(`Imagen no encontrada: ${path.basename(imagePath)}`)
      errors++
      continue
    }

    // Generar slug base (sin color)
    const baseSlug = generateSlug(productName)

    if (!productsMap.has(baseSlug)) {
      productsMap.set(baseSlug, {
        name: productName,
        category,
        audience,
        fabric,
        price: parseFloat(price) || 45.00,
        stock: parseInt(stock) || 10,
        colors: new Set(),
        images: []
      })
    }

    const product = productsMap.get(baseSlug)
    product.colors.add(color)
    product.images.push({
      path: imagePath,
      color,
      slug: `${baseSlug}-${generateSlug(color)}`
    })

    processed++
    if (processed % 50 === 0) {
      log.info(`Procesadas: ${processed}/${lines.length}`)
    }

  } catch (error) {
    log.error(`Error procesando l√≠nea: ${error.message}`)
    errors++
  }
}

log.title('üìä RESUMEN')
console.log(`Im√°genes procesadas: ${processed}`)
console.log(`Productos √∫nicos: ${productsMap.size}`)
console.log(`Errores: ${errors}\n`)

// Generar TypeScript code
log.info('Generando c√≥digo TypeScript...')

let tsCode = `// Auto-generated by process-csv-batch.js\n`
tsCode += `// ${new Date().toISOString()}\n\n`
tsCode += `import { Product } from "./products"\n\n`
tsCode += `export const generatedProducts: Product[] = [\n`

let idCounter = 1000

for (const [baseSlug, product] of productsMap) {
  tsCode += `  {\n`
  tsCode += `    id: ${idCounter++},\n`
  tsCode += `    slug: "${baseSlug}",\n`
  tsCode += `    name: "${product.name}",\n`
  tsCode += `    category: "${product.category}",\n`
  tsCode += `    audience: "${product.audience}",\n`
  tsCode += `    fabric: "${product.fabric}",\n`
  tsCode += `    price: ${product.price},\n`
  tsCode += `    stock: ${product.stock},\n`
  tsCode += `    image: "/products/${product.images[0].slug}.webp",\n`
  tsCode += `    images: [\n`

  for (const img of product.images) {
    tsCode += `      "/products/${img.slug}.webp",\n`
  }

  tsCode += `    ],\n`

  if (product.colors.size > 1) {
    tsCode += `    colors: [\n`
    for (const color of product.colors) {
      tsCode += `      { name: "${color}", value: "#000000" },\n`
    }
    tsCode += `    ],\n`
  }

  tsCode += `  },\n`
}

tsCode += `]\n`

const outputPath = path.join(__dirname, '..', 'data', 'products-generated.ts')
fs.writeFileSync(outputPath, tsCode)

log.success(`C√≥digo generado: ${outputPath}`)

log.title('‚ö†Ô∏è IMPORTANTE - PR√ìXIMOS PASOS')
console.log('1. Las im√°genes A√öN est√°n en formato JPG/PNG')
console.log('2. Necesitas convertirlas a WebP manualmente:')
console.log('')
console.log('   OPCI√ìN A - Usar Sharp (Node.js):')
console.log('   node scripts/convert-images-to-webp.js')
console.log('')
console.log('   OPCI√ìN B - Usar herramienta online:')
console.log('   https://cloudconvert.com/jpg-to-webp')
console.log('')
console.log('3. Despu√©s copiar los WebP a public/products/')
console.log('4. Mergear products-generated.ts con products.ts')
console.log('')

function generateSlug(text) {
  return text
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '')
}

log.success('‚úì Proceso completado!')
